___INFO___

{
  "displayName": "Snowplow Analytics",
  "description": "Snowplow Analytics Base Tracking Tag",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,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",
    "displayName": "",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "macrosInSelect": false,
    "alwaysInSummary": true,
    "selectItems": [
      {
        "displayValue": "Base Tag + Page View",
        "value": "basePageView"
      },
      {
        "displayValue": "Page View",
        "value": "pageView"
      },
      {
        "displayValue": "Structured Event",
        "value": "structuredEvent"
      },
      {
        "displayValue": "Self-Describing Event",
        "value": "customEvent"
      },
      {
        "displayValue": "Page Ping",
        "value": "pagePing"
      }
    ],
    "displayName": "Tag Type",
    "simpleValueType": true,
    "name": "trackType",
    "type": "SELECT"
  },
  {
    "macrosInSelect": true,
    "selectItems": [],
    "displayName": "Snowplow Analytics Settings Variable",
    "simpleValueType": true,
    "name": "snowplowSettings",
    "type": "SELECT"
  },
  {
    "help": "Custom contexts to add to this tag / event in addition to the global contexts.",
    "displayName": "Custom Contexts",
    "simpleValueType": true,
    "name": "eventContexts",
    "type": "TEXT"
  },
  {
    "enablingConditions": [
      {
        "paramName": "trackType",
        "type": "EQUALS",
        "paramValue": "basePageView"
      }
    ],
    "simpleValueType": true,
    "name": "enableActivityTracking",
    "checkboxText": "Enable Activity Tracking",
    "type": "CHECKBOX"
  },
  {
    "enablingConditions": [
      {
        "paramName": "enableActivityTracking",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "valueValidators": [
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "displayName": "Minimum Visit Length",
    "defaultValue": 30,
    "simpleValueType": true,
    "name": "startTrackingAfter",
    "valueUnit": "seconds",
    "type": "TEXT",
    "valueHint": "30"
  },
  {
    "enablingConditions": [
      {
        "paramName": "enableActivityTracking",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "valueValidators": [
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "displayName": "Heartbeat Interval",
    "defaultValue": 10,
    "simpleValueType": true,
    "name": "trackEvery",
    "valueUnit": "seconds",
    "type": "TEXT",
    "valueHint": "10"
  },
  {
    "enablingConditions": [
      {
        "paramName": "trackType",
        "type": "EQUALS",
        "paramValue": "customEvent"
      },
      {
        "paramName": "trackType",
        "type": "EQUALS",
        "paramValue": "structuredEvent"
      }
    ],
    "displayName": "Event Settings",
    "name": "eventSettings",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "help": "",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "type": "EQUALS",
            "paramValue": "customEvent"
          }
        ],
        "displayName": "Self-describing Event Schema",
        "simpleValueType": true,
        "name": "eventSchema",
        "type": "TEXT"
      },
      {
        "enablingConditions": [
          {
            "paramName": "trackType",
            "type": "EQUALS",
            "paramValue": "structuredEvent"
          }
        ],
        "displayName": "Event Category",
        "simpleValueType": true,
        "name": "eventCategory",
        "type": "TEXT"
      },
      {
        "enablingConditions": [
          {
            "paramName": "trackType",
            "type": "EQUALS",
            "paramValue": "structuredEvent"
          }
        ],
        "displayName": "Event Action",
        "simpleValueType": true,
        "name": "eventAction",
        "type": "TEXT"
      },
      {
        "enablingConditions": [
          {
            "paramName": "trackType",
            "type": "EQUALS",
            "paramValue": "structuredEvent"
          }
        ],
        "displayName": "Event Label",
        "simpleValueType": true,
        "name": "eventLabel",
        "type": "TEXT"
      },
      {
        "enablingConditions": [
          {
            "paramName": "trackType",
            "type": "EQUALS",
            "paramValue": "structuredEvent"
          }
        ],
        "displayName": "Event Property",
        "simpleValueType": true,
        "name": "eventProperty",
        "type": "TEXT"
      },
      {
        "enablingConditions": [
          {
            "paramName": "trackType",
            "type": "EQUALS",
            "paramValue": "structuredEvent"
          }
        ],
        "valueValidators": [
          {
            "type": "NUMBER"
          }
        ],
        "displayName": "Event Value",
        "simpleValueType": true,
        "name": "eventValue",
        "type": "TEXT"
      }
    ]
  },
  {
    "enablingConditions": [
      {
        "paramName": "trackType",
        "type": "EQUALS",
        "paramValue": "basePageView"
      }
    ],
    "displayName": "Advanced",
    "name": "advancedSettings",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "help": "The key that GTM uses to decide if the script can be loaded from cache or must be loaded from the server. Defaults to the URL of the script if blank.",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "type": "EQUALS",
            "paramValue": "basePageView"
          }
        ],
        "displayName": "Script Cache Key",
        "simpleValueType": true,
        "name": "scriptCacheKey",
        "type": "TEXT"
      }
    ]
  }
]


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "GlobalSnowplowNamespace"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "GlobalSnowplowNamespace.push"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sp"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sp.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sp.q.push"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "snowplow"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "snowplow.q"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "snowplow.q.push"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://d1fc8wv8zag5ca.cloudfront.net/2.10.0/sp.js"
              },
              {
                "type": 1,
                "string": "https://*.dev.miysource.com/js/indicium.js"
              },
              {
                "type": 1,
                "string": "https://*.local.miysource.com/js/indicium.js"
              },
              {
                "type": 1,
                "string": "https://*.test.miysource.com/js/indicium.js"
              },
              {
                "type": 1,
                "string": "https://*.content.miysource.com/js/indicium.js"
              },
              {
                "type": 1,
                "string": "https://*.uat.makeityoursource.com/js/indicium.js"
              },
              {
                "type": 1,
                "string": "https://*.makeityoursource.com/js/indicium.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const getType = require('getType');
const callInWindow = require('callInWindow');
const setInWindow = require('setInWindow');
const createArgumentsQueue = require('createArgumentsQueue');
const injectScript = require('injectScript');

//Tag Level Variables
const url = data.snowplowSettings.trackerJSFileUrl;
const trackType = data.trackType;
const trackerName = data.snowplowSettings.trackerName;
const cacheKey = data.scriptCacheKey || url;

//Mutable Variables
let eventContexts = data.eventContexts;
let eventSchema = data.eventSchema || {};
let globalContexts = data.snowplowSettings.globalContexts;

//Setup Aliased Tracker Function
const tracker = function(){callInWindow(trackerName + '.q.push', arguments);};

//Setup Global Contexts
if(globalContexts) {
  if(getType(globalContexts) === 'function') {
    globalContexts = globalContexts();
  }
  log('Found Global Contexts:', globalContexts);
}

//Setup Event Contexts
if(getType(eventContexts) === 'function') {
  eventContexts = eventContexts();
   log('Found Event Contexts:', eventContexts);
}

const onSuccess = () => {
  log('Snowplow: Script Loaded.');
  data.gtmOnSuccess();
};

const onFailure = () => {
  log('Snowplow: Loading script failed!');
  data.gtmOnFailure();
};

const trackPageView = () => {
  tracker('trackPageView', eventContexts);
};

const enableActivityTracking = () => {
   data.startTrackingAfter = data.startTrackingAfter -0;
   data.trackEvery = data.trackEvery -0;
   tracker('enableActivityTracking', data.startTrackingAfter, data.trackEvery);
};

const setupTracker = () => {
  
    //Show the tag data for debugging;
    log('Using Snowplow Settings: ', data);
  
	//Setup Global Namespace
	setInWindow('GlobalSnowplowNamespace', []);
    
    //Create Arguments Queue
    const sp = createArgumentsQueue(trackerName, trackerName + '.q');

    //Add Tracker to Global Namespace
    callInWindow('GlobalSnowplowNamespace.push', trackerName);
    
    setInWindow(trackerName, sp);
    
    //Create new tracker
    sp("newTracker", trackerName, data.snowplowSettings.collectorAddress, data.snowplowSettings);
    
    if(data.enableActivityTracking) {
      	//Setup Page Pings
    	enableActivityTracking();
    }
    
    if(globalContexts) {
      log('Adding Global Contexts:', globalContexts);
      sp('addGlobalContexts', globalContexts);
    }
};

switch(trackType) {
  case 'basePageView':
    log('Snowplow Base Tag Fired');
    //Setup Tracker
    setupTracker();
    
    //Add Page View to Queue
    trackPageView();

    //Inject the snowplow script.   
    injectScript(url, onSuccess, onFailure, cacheKey);
    break;
    
  case 'pageView':
    log('Snowplow Page View Fired');
    trackPageView();
    data.gtmOnSuccess();
    break;
    
  case 'structuredEvent':
    log('Snowplow Structure Event Fired');
    tracker('trackStructEvent', data.eventCategory, data.eventAction, data.eventLabel, data.eventProperty, data.eventValue, eventContexts);
    data.gtmOnSuccess();
    break;
    
  case 'pagePing':
    log('Snowplow Page Ping Fired');
    tracker('updatePageActivity');
    data.gtmOnSuccess();
    break;
    
  case 'customEvent':
    log('Snowplow Custom Event Fired');
    tracker('trackSelfDescribingEvent', eventSchema, eventContexts);
    data.gtmOnSuccess();
    break;
    
}


___NOTES___

Created on 9/25/2019, 1:30:42 AM
