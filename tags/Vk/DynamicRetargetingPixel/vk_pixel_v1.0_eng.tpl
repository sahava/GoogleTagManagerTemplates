___INFO___

{
  "displayName": "VK Pixel",
  "description": "VK dynamic retargeting pixel v1.0. Created by Oleg Denisov",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/jpeg;base64,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",
    "displayName": "Adventum",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "macrosInSelect": false,
    "selectItems": [
      {
        "displayValue": "Hit",
        "value": "hit"
      },
      {
        "displayValue": "View Home",
        "value": "view_home"
      },
      {
        "displayValue": "View Category",
        "value": "view_category"
      },
      {
        "displayValue": "View Search",
        "value": "view_search"
      },
      {
        "displayValue": "View Other",
        "value": "view_other"
      },
      {
        "displayValue": "View Product",
        "value": "view_product"
      },
      {
        "displayValue": "Add To Cart",
        "value": "add_to_cart"
      },
      {
        "displayValue": "Remove From Cart",
        "value": "remove_from_cart"
      },
      {
        "displayValue": "Init Checkout",
        "value": "init_checkout"
      },
      {
        "displayValue": "Purchase",
        "value": "purchase"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Event you want to track",
    "simpleValueType": true,
    "name": "event",
    "type": "SELECT"
  },
  {
    "help": "If there are 2 or more pixels, you must separate their ID with a comma.",
    "alwaysInSummary": false,
    "valueValidators": [
      {
        "errorMessage": "At least one VK pixel must be specified",
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Pixel IDs",
    "simpleValueType": true,
    "name": "pixelIDs",
    "type": "TEXT",
    "valueHint": "VK-RTRG-xxxxxx-xxxxx,VK-RTRG-xxxxxx-xxxxx"
  },
  {
    "valueValidators": [
      {
        "errorMessage": "You must specify the price list ID",
        "type": "NON_EMPTY"
      },
      {
        "enablingConditions": [],
        "errorMessage": "The price list ID must be a positive integer",
        "type": "POSITIVE_NUMBER"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "fewPriceLists",
        "type": "EQUALS",
        "paramValue": false
      }
    ],
    "displayName": "Price list ID",
    "simpleValueType": true,
    "name": "priceListId",
    "type": "TEXT",
    "valueHint": "1234"
  },
  {
    "enablingConditions": [
      {
        "paramName": "event",
        "type": "NOT_EQUALS",
        "paramValue": "hit"
      }
    ],
    "simpleValueType": true,
    "name": "fewPriceLists",
    "checkboxText": "Use multiple price lists",
    "type": "CHECKBOX"
  },
  {
    "enablingConditions": [
      {
        "paramName": "fewPriceLists",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "valueValidators": [
      {
        "errorMessage": "You must specify at least one pair Hostname - Price list ID",
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "Price list IDs",
    "name": "priceListIds",
    "paramTableColumns": [
      {
        "param": {
          "help": "",
          "valueValidators": [
            {
              "errorMessage": "Host must be specified",
              "type": "NON_EMPTY"
            },
            {
              "args": [
                "(.*)\\.(.*)"
              ],
              "errorMessage": "The host is specified incorrectly",
              "type": "REGEX"
            }
          ],
          "displayName": "Hostname",
          "simpleValueType": true,
          "name": "hostname",
          "type": "TEXT",
          "valueHint": "example.com"
        },
        "isUnique": true
      },
      {
        "param": {
          "help": "",
          "valueValidators": [
            {
              "errorMessage": "You must specify the price list ID for this host",
              "type": "NON_EMPTY"
            },
            {
              "errorMessage": "The price list ID must be a positive integer",
              "type": "POSITIVE_NUMBER"
            }
          ],
          "displayName": "Price list ID",
          "simpleValueType": true,
          "name": "priceListId",
          "type": "TEXT",
          "valueHint": "1111"
        },
        "isUnique": true
      }
    ],
    "type": "PARAM_TABLE"
  },
  {
    "help": "If the site is configured with Google Enhanced Ecommerce using dataLayer, then GA Ecommerce data can be used to transfer products and event parameters to the pixel.",
    "enablingConditions": [
      {
        "paramName": "event",
        "type": "NOT_EQUALS",
        "paramValue": "hit"
      }
    ],
    "simpleValueType": true,
    "name": "ecommerceUse",
    "checkboxText": "Use GA Enhanced Ecommerce data to transfer products and event parameters to the pixel",
    "type": "CHECKBOX"
  },
  {
    "help": "GTM variable with GA Enhanced Ecommerce object for this event. For example: dataLayer.ecommerce.add, dataLayer.ecommerce.remove, dataLayer.ecommerce.impressions, etc.",
    "enablingConditions": [
      {
        "paramName": "ecommerceUse",
        "type": "EQUALS",
        "paramValue": true
      }
    ],
    "valueValidators": [
      {
        "errorMessage": "You must specify GA Enhanced Ecommerce object for this event.",
        "type": "NON_EMPTY"
      }
    ],
    "displayName": "GA Enhanced Ecommerce object for this event",
    "simpleValueType": true,
    "name": "eventEcommerce",
    "type": "TEXT",
    "valueHint": "{{varDL_ecommerce.impressions}}"
  },
  {
    "help": "If you leave the field empty, the search query will not be transmitted with site search event.",
    "enablingConditions": [
      {
        "paramName": "event",
        "type": "EQUALS",
        "paramValue": "view_search"
      }
    ],
    "displayName": "Site search query URL parameter",
    "simpleValueType": true,
    "name": "siteSearchQueryParam",
    "type": "TEXT",
    "valueHint": "search"
  }
]


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "VK"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "vkAsyncInit"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "VK.Retargeting.Init"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "VK.Retargeting.Hit"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "VK.Retargeting.ProductEvent"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "openapiInject"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://vk.com/js/api/openapi.js?159"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

//api
const copyFromWindow = require('copyFromWindow');
const setInWindow = require('setInWindow');
const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const makeTableMap = require('makeTableMap');
const getUrl = require('getUrl');
const getQueryParameters = require('getQueryParameters');
const makeInteger = require('makeInteger');
const makeString = require('makeString');
const callLater = require('callLater');

//user settings object
const settings = {
    event: data.event,
    pixelIDs: data.pixelIDs,
    priceListId: data.priceListId,
    fewPriceLists: data.fewPriceLists,
    priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'),
    ecommerceUse: data.ecommerceUse,
    eventEcommerce: data.eventEcommerce,
    siteSearchQueryParam: data.siteSearchQueryParam
};

//main object
const pixel = {
    //get page host method
    getPageHostname: () => getUrl('host'),

    //get VK object method
    getVK: () => copyFromWindow('VK'),

    //set VK openapi.js callback method
    setVkAsyncInit: () => {
        setInWindow('vkAsyncInit', pixel.sendEvent);
    },

    //get site search phrase method
    getSiteSearchPhrase: () => {
        if (settings.event === 'view_search') return getQueryParameters(settings.siteSearchQueryParam);
        else return undefined;
    },

    //get event parameters method
    getEventParams: (products, currencyCode, revenue) => {
        const eventParamsClean= {};
        const eventParams = {
            products: eventProducts.getProductParams(products),
            category_ids: eventProducts.getCategoryString(products),
            currency_code: currencyCode,
            total_price: eventProducts.getTotalPrice(products, revenue),
            search_string: pixel.getSiteSearchPhrase()
        };
        if (eventParams.products !== undefined) eventParamsClean.products = eventParams.products;
        if (eventParams.category_ids !== undefined) eventParamsClean.category_ids = eventParams.category_ids;
        if (eventParams.currency_code !== undefined) eventParamsClean.currency_code = eventParams.currency_code;
        if (eventParams.total_price !== undefined) eventParamsClean.total_price = eventParams.total_price;
        if (eventParams.search_string !== undefined) eventParamsClean.search_string = eventParams.search_string;
        return eventParamsClean;
    },

    //get price list ID method
    getPriceListId: hostname => {
        if (settings.fewPriceLists) return settings.priceListIds[hostname];
        else return settings.priceListId;
    },

    //VK openapi.js init method
    openapiInit: () => {
        injectScript('https://vk.com/js/api/openapi.js?159', pixel.setVkAsyncInit, data.gtmOnFailure, 'vkPixel');
        setInWindow('openapiInject', 1);
    },

    //send event method
    sendEvent: () => {
        if (settings.event === 'hit') {
            settings.pixelIDs.split(',').forEach(p => {
                callInWindow('VK.Retargeting.Init',p);
                callInWindow('VK.Retargeting.Hit');
            });
        } else {
            const pricelist = pixel.getPriceListId(pixel.getPageHostname());
            const name = settings.event;
            let products = [];
            if(settings.ecommerceUse) products = name === 'view_home' || name === 'view_category' || name === 'view_search' || name === 'view_other' ? settings.eventEcommerce : settings.eventEcommerce.products;
            else products = undefined;
            const currencyCode = settings.ecommerceUse ? settings.eventEcommerce.currencyCode : undefined;
            const revenue = (settings.ecommerceUse && name === 'purchase') ? settings.eventEcommerce.actionField.revenue : undefined;
            const eventParams = settings.ecommerceUse ? pixel.getEventParams(products, currencyCode, revenue) : undefined;
            settings.pixelIDs.split(',').forEach(p => {
                callInWindow('VK.Retargeting.Init',p);
                callInWindow('VK.Retargeting.ProductEvent', pricelist, name, eventParams);
            });
        }
    },

    //pixel start method
    start: () => {
        if (pixel.getVK() === undefined && copyFromWindow('openapiInject') !== 1) {
            pixel.openapiInit();
            data.gtmOnSuccess();
        } else if (pixel.getVK() === undefined && copyFromWindow('openapiInject') === 1) {
            if (pixel.count < 50) {
                callLater(pixel.start);
                pixel.count++;
            } else return;
        } else {
            pixel.sendEvent();
            data.gtmOnSuccess();
        }
    },

    //start attempts counter
    count: 0
};

//object with methods for processing an array of event products
const eventProducts = {
    //get product parameters method
    getProductParams: products => {
        const arr = [];
        products.forEach(i => {
            const productParamsClean = {};
            const productParams = {
                id: makeString(i.id),
                group_id: makeString(i.brand),
                price: makeInteger(i.price * 100) / 100
            };
            if (productParams.id !== 'undefined') productParamsClean.id = productParams.id;
            if (productParams.group_id !== 'undefined') productParamsClean.group_id = productParams.group_id;
            if (productParams.price !== 0) productParamsClean.price = productParams.price;
            arr.push(productParamsClean);
        });
        return arr;
    },

    //get unique product categories method. Return a string. String type is 'a,b,c'
    getCategoryString: products => {
        let categoryId = '';
        const check = [];
        products.forEach(i => {
            if(check.indexOf(i.category) === -1) {
                check.push(i.category);
                categoryId += ',' + i.category;
            }
        });
        return categoryId.slice(1);
    },

    //get total price method
    getTotalPrice: (products, revenue) => {
        let sumPrice = 0;
        if (revenue !== undefined ) return makeInteger(revenue * 100) / 100;
        else {
            products.forEach(i => {
                if (i.hasOwnProperty('quantity')) sumPrice += (makeInteger(i.price * 100) / 100) * makeInteger(i.quantity);
                else sumPrice += makeInteger(i.price * 100) / 100;
            });
            return sumPrice;
        }
    }
};

//let's run the pixel :)
pixel.start();


___NOTES___

Created on 14.06.2019, 11:41:50
